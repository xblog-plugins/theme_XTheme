/*登录注册界面js文件*/
/*忘记密码*/
function forgetPassword(that){that.$prompt('请输入邮箱地址，你会收到一封带有重置密码链接的电子邮件','提示',{confirmButtonText:'确定',cancelButtonText:'取消',inputPattern:/[\w!#$%&'*+/=?^_`{|}~-]+(?:\.[\w!#$%&'*+/=?^_`{|}~-]+)*@(?:[\w](?:[\w-]*[\w])?\.)+[\w](?:[\w-]*[\w])?/, inputErrorMessage: '邮箱格式不正确'}).then(({ value }) => {xy.net.request('user/password/email','POST',{email:value}).then(() => {that.$message.success('重置链接已发至你的邮箱')}).catch((msg)=>{that.$message.error(msg)})}).catch(()=>{})}
/*注册界面*/
if($("#signup").length>0){let checkCode;function createTheCode(el){checkCode='';const codeLength=4;const canvas=document.getElementById(el);const selectChar=[0,1,2,3,4,5,6,7,8,9,'A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'];for(let i=0;i<codeLength;i++){const charIndex=Math.floor(Math.random()*36);checkCode+=selectChar[charIndex]}if(canvas){const ctx=canvas.getContext('2d');ctx.fillStyle='#FFFFFF';ctx.fillRect(0,0,70,27);ctx.font='20px arial';const gradient=ctx.createLinearGradient(0,0,canvas.width,0);gradient.addColorStop(0,'magenta');gradient.addColorStop(0.5,'blue');gradient.addColorStop(1.0,'red');ctx.strokeStyle=gradient;ctx.strokeText(checkCode,5,20)}}function verifyCode(code){return checkCode.toLowerCase()===code.toLowerCase()}new Vue({el:'#signup',data(){return{loading:false,registered:{username:'',password:'',nickname:'',email:'',repeat:'',verify:''},rules:{username:[{validator:(rule,value,callback)=>{const re=/^[0-9a-zA-Z]*$/;if(value.length<4){callback(new Error('用户名位数不能小于4位'))}else if(!re.test(value)){callback(new Error('用户名必须由数字和字母组成'))}else{xy.net.request("user/username","GET",{user:value}).then(()=>{callback(new Error('该用户已注册'))}).catch(_=>callback())}},trigger:'blur'}],password:[{validator:(rule,value,callback)=>{value.length<5?callback(new Error('你的密码太简单了，密码至少5位数哦')):callback()},trigger:'blur'}],nickname:[{required:true,message:'请填写昵称'}],repeat:[{validator:(rule,value,callback)=>{value!==this.registered.password?callback(new Error('两次输入的密码不一致')):callback()},trigger:'blur'}],email:[{validator:(rule,value,callback)=>{if(xy.validate.checkEmail(value)){xy.net.request("user/username","GET",{email:value}).then(()=>{callback(new Error('该邮箱已注册'))}).catch(_=>callback())}else{callback(new Error('邮箱格式不正确'))}},trigger:'blur'}],verify:[{validator:(rule,value,callback)=>{verifyCode(value)?callback():callback(new Error('验证码错误'))}}]}}},mounted(){this.createCode()},methods:{loginButton(){this.$refs.logindata.validate((valid)=>{if(valid){this.loading=true;xy.net.request('user',"POST",this.registered).then(()=>{this.$message.success('激活邮件已发至你的邮箱，请注意查收并激活！');setTimeout(()=>{window.location.href="/"},2000)}).catch((msg)=>{this.$message.error(msg)}).finally(()=>{this.loading=false})}else{return false}})},createCode(){createTheCode('code')},forget(){forgetPassword(this)}}})}
/*登录界面*/
if($("#login").length>0){new Vue({el:'#login',data:{loginIng:false,loginData:{username:'',password:'',remember:''},rules:{user:[{required:true,message:'请填写用户名'}],password:[{required:true,message:'请填写密码'}]},visible:false},methods:{forget(){forgetPassword(this)},loginButton(){this.$refs.ruleForm.validate((valid)=>{if(valid){this.visible=true;this.login()}})},login(){this.loginIng=true;xy.net.request("user/token","POST",this.loginData).then((data)=>{this.$message.success('登录成功！正在跳转到主页...');if(this.loginData.remember!==''){this.setCookie(data,30)}else{this.setCookie(data,0)}setTimeout(()=>{window.location.href='/'},1000)}).catch((res)=>{this.$message.error(res)}).finally(()=>{this.loginIng=false})},setCookie(data,day){xy.tools.setCookie('token',JSON.stringify(data),day,"/")}}})}

